{% extends "images/base_image.html" %}
{% load i18n %}
{% load guardian_tags %}
{% load dajaxice_templatetags %}

{% block title %}Annotation Tool | CoralNet{% endblock %}

{% block media-includes %}
    {{ block.super }}
    {% include "jquery-hotkeys-include.html" %}
    {% dajaxice_js_import %}
    <script src="/static/js/util.js" type="text/javascript"></script>
    <script src="/static/js/AnnotationToolHelper.js" type="text/javascript"></script>
{% endblock %}

{% block css-code %}
<style type="text/css">

/* For the image and canvas, use position:absolute
 * and make their positions the same (default of 0,0).  This'll make
 * them overlap.  Use z-index to determine which "layers" are on
 * top or bottom.  Also, the surrounding div must have
 * position:relative so that the image and canvas don't overlap
 * the rest of the page elements.
 */

#annotationArea {
    position: relative;
}

#imageArea {
    position: absolute;
    overflow: hidden;
}
#coralImage {
    position: absolute;
}
#pointsCanvas {
    position: absolute;
}
#listenerElmt {
    position: absolute;

    /* Disable "selecting" this element by double-clicking it;
       that can get in the way while trying to zoom. */
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -o-user-select: none;
    user-select: none;
}

#labelButtons button {
    width: 75px;
    border: 3px solid transparent;
    margin: 2px;

    cursor: pointer;
}
#labelButtons button.current {
    border: 3px solid #000000;
}

/* TODO: Probably want to consider assigning a certain color for each functional group
 * and using that color site-wide.  For example, always green for hard coral.
 * (Maybe make the colors customizable too?) */
#labelButtons button.group1{ background-color: #8888ff; }
#labelButtons button.group2{ background-color: #ff8888; }
#labelButtons button.group3{ background-color: #88ff88; }
#labelButtons button.group4{ background-color: #88ffff; }
#labelButtons button.group5{ background-color: #ff88ff; }
#labelButtons button.group6{ background-color: #ffff88; }
#labelButtons button.group7{ background-color: #888888; }
#labelButtons button.group8{ background-color: #4499dd; }

#mainColumn {
    float: left;

    /* width and height are set dynamically. */
}

#rightSidebar {
    float: left;

    /* width and height are set dynamically. */
}

#dummyColumn {
    /* height is set dynamically. */
}

#toolButtonArea {
    margin: 5px 0;    /* top and bottom 5px */
    text-align: center;
}
#toolButtonArea input[type="image"] {
    border: 2px solid #888888;
}
#toolButtonArea input[type="image"].selected {
    border: 2px solid #FF0000;
}

#annotationList {
    /* scrollbars will appear only if they're necessary */
    overflow: auto;
    
    /* height is set dynamically. */
}

#annotationForm {
    width: auto;
    margin: auto;
    padding: 0;
}

/* Label fields */
#annotationForm input {
    margin: 1px 0;
    padding: 1px 1px;
}

/* Currently selected points */
#annotationForm tr.selected span.annotationFormLabel {
    background-color: #CCFFCC;
}

/* Robot annotated, not human confirmed yet */
#annotationForm tr.robot input {
    color: #888888;
}

/* Label field has an invalid label code */
#annotationForm tr.error input {
    background-color: #FFCCCC;
}

/* Numbers next to the label fields */
.annotationFormLabel {
    padding: 1px 3px;
    margin: 0 2px;
    border: 1px solid #D7D7D7;

    /* Use the regular arrow cursor, not the text highlight cursor */
    cursor: default;

    /* Make the number's clickable box take up the whole table cell */
    display: block;
}

/* Table cell containing an annotationFormLabel */
td.annotationFormLabelCell {
    text-align: center;
}

#allDone {
    color: blue;
    display: block;
    font-size: 1.3em;
    font-weight: bold;
    margin: 5px;
}

#id_instructions_wrapper div.help_section {
    margin-bottom: 10px;
}

#id_instructions_wrapper div.help_section ul {
    list-style: disc none inside;
}
#id_instructions_wrapper div.help_section ul li ul {
    padding-left: 20px;
}

#id_instructions_wrapper div.help_section span.help_header {
    font-weight: bold;
    line-height: 2.0em;
}

</style>
{% endblock %}

{% block content %}

<p>Image: {{ metadata.name }}</p>
<p>Location keys: {{ location_values|default:"(Unknown)" }}</p>
<p>Year: {{ metadata.photo_date.year|default:"(Unknown)" }}</p>
<p>Annotation point type: {{ image.point_gen_method_display }}</p>

<button id="id_button_show_instructions">Help/Controls</button>

<div id="id_instructions_wrapper" style="display:none">
  <button id="id_button_hide_instructions">Hide Help</button>

  <hr/>

  <p>The text fields on the right show the current labels for each point.
      If the text is in <span style='color:#888888'>gray</span>,
      the point is robot-annotated and needs to be confirmed by a human annotator.
      If the background is in <span style='background-color:#FFCCCC'>red</span>,
      the text is not a valid label code and needs to be changed.</p>

  <p>The image shows the locations of the points.
      Unannotated points are in <span style='color:#8888FF'>blue</span>,
      annotated points are in <span style='color:#FFFF00; background-color:#888888'>yellow</span>,
      and selected points are in <span style='color:#00FF00'>green</span>.</p>

  <div class="help_section">
      <span class="help_header">Choosing a point to label</span>
      <ul>
          <li>Click in one of the text fields on the right.</li>
          <li>Move to the next or previous point's text field with the Down and Up arrow keys.</li>
      </ul>
  </div>

  <div class="help_section">
      <span class="help_header">Labelling the chosen point</span>
      <ul>
          <li>Below the image are a grid of label buttons, one button for each label in your Source's labelset.
              Click the button corresponding to the label you want to use.</li>
          <li>You may also type the label code directly into the text field.</li>
      </ul>
  </div>

  <div class="help_section">
      <span class="help_header">Confirming or changing a label</span>
      <ul>
          <li>Press Enter to confirm a robot-annotated label and move onto the next point.</li>
          <li>Hold Shift and use the arrow keys to quickly choose a different label from the button grid.</li>
      </ul>
  </div>

  <div class="help_section">
      <span class="help_header">Saving your work</span>
      <ul>
          <li>Click the "Save Progress" button on the lower right to save your work.
              There are two cases where you won't be able to save:
              <ul>
                  <li>When no changes have been made.  In this case, the button text will be "Saved".</li>
                  <li>When any point is labelled with an invalid label code.  In this case, the button text will be "Error".</li>
              </ul>
          </li>
      </ul>
  </div>

  <div class="help_section">
      <span class="help_header">Selecting and labelling multiple points</span>
      <ul>
          <li>Select multiple points by Ctrl-clicking the points on the image.</li>
          <li>You may also click the numbers next to the text fields.</li>
          <li>For more multi-select options, use these buttons on the upper right:
              <img src="/static/img/Icon_select-none.png"/>,
              <img src="/static/img/Icon_select-unannotated.png"/>,
              and <img src="/static/img/Icon_select-inversion.png"/>.</li>
          <li>Once multiple points are selected, label them all by clicking a label button.</li>
      </ul>
  </div>

  <div class="help_section">
      <span class="help_header">Getting a better look at a point</span>
      <ul>
          <li>To zoom in, left-click on the image or press Ctrl+Up.</li>
          <li>To zoom out, right-click on the image or press Ctrl+Down.</li>
          <li>To toggle between different point display modes, use these buttons on the upper right:
              <img src="/static/img/Icon_point-mode-all.png"/>,
              <img src="/static/img/Icon_point-mode-selected.png"/>,
              and <img src="/static/img/Icon_point-mode-none.png"/>.</li>
      </ul>
  </div>

  <hr/>
</div>

<div>
    <div id="mainColumn">
      <div id="annotationArea">

        <!-- HTML5 canvas element for drawing points -->
        <canvas id="pointsCanvas"></canvas>

        <div id="imageArea">

          <!-- The coral image  -->
          <img id="coralImage" src="{{ image.original_file.url }}" />

          <!-- Dummy element for listening to mouseclicks, etc. -->
          <div id="listenerElmt"></div>

        </div>
          
      </div>

      <div id="labelButtons">
        {% for label in labels %}
            <button>{{ label.code }}</button>
        {% endfor %}
      </div>
    </div>

    <div id="rightSidebar">

     <div id="toolButtonArea">
         <input class="pointModeButton" type="image"
                id="pointModeButtonAll" src="/static/img/Icon_point-mode-all.png" title="Show all points"/>
         <input class="pointModeButton" type="image"
                id="pointModeButtonSelected" src="/static/img/Icon_point-mode-selected.png" title="Show selected points only"/>
         <input class="pointModeButton" type="image"
                id="pointModeButtonNone" src="/static/img/Icon_point-mode-none.png" title="Hide all points"/>
         <br/>

         <input class="quickSelectButton" type="image"
                id="quickSelectButtonNone" src="/static/img/Icon_select-none.png" title="Un-select all points"/>
         <input class="quickSelectButton" type="image"
                id="quickSelectButtonUnannotated" src="/static/img/Icon_select-unannotated.png" title="Select all unannotated points"/>
         <input class="quickSelectButton" type="image"
                id="quickSelectButtonInvert" src="/static/img/Icon_select-inversion.png" title="Invert current selections"/>
     </div>

     <form id="annotationForm"
          action="" method="post">{% csrf_token %}

      {% for field in form.hidden_fields %}
          {{ field }}
      {% endfor %}

      <div id="annotationList">

        <table>

        {% for field in form.visible_fields %}
          <tr>
            <td class="annotationFormLabelCell">
                <span class="annotationFormLabel">{{ field.label }}</span>
            </td>
            <td>
                {{ field }}
            </td>
          </tr>
        {% endfor %}
        
        </table>

      </div>

      <!-- type="button" ensures that the button doesn't do a non-Ajax form submit -->
      <button id="saveButton" type="button">Save progress</button>

      <div id="allDone"></div>

     </form>

    </div>

    <!--
    Column layouts work best when each column can float left - but at the same time,
    there needs to be one column at the end that doesn't float, so it can take up page space,
    which ensures that the page footer appears below everything.
    This column exists for this sole purpose.
    -->
    <div id="dummyColumn"></div>

</div>

<!-- Script in the body will run on page load. -->
<script type="text/javascript">
    // Initialize the Annotation Tool Helper (ATH) object.
    ATH.init({{ image.original_height }},
             {{ image.original_width }},
             {{ annotationsJSON|safe }},
             {{ labelsJSON|safe }});
</script>

{% endblock %}
